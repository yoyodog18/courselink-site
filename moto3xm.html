<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Session</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: white;
      font-family: sans-serif;
    }

    #remapPopup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    #remapPopup h2 {
      margin-bottom: 0.5rem;
    }

    #remapPopup p {
      font-size: 0.9rem;
      max-width: 320px;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .bind-row {
      margin: 0.25rem 0;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      padding: 0.6rem 1.4rem;
      font-size: 1rem;
      background: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
    }

    iframe {
      border: none;
      width: 100vw;
      height: 100vh;
      display: none;
    }
  </style>
</head>
<body>

  <!-- Key Remap Popup -->
  <div id="remapPopup">
    <h2>üõ°Ô∏è Input Setup</h2>
    <p>
      Some monitoring software flags repeated inputs like arrow keys. Choose alternate keys for movement.
    </p>
    <div class="bind-row">Up: <span id="keyUp">[Press key]</span></div>
    <div class="bind-row">Down: <span id="keyDown">[Press key]</span></div>
    <div class="bind-row">Left: <span id="keyLeft">[Press key]</span></div>
    <div class="bind-row">Right: <span id="keyRight">[Press key]</span></div>

    <div class="button-group">
      <button id="startButton" disabled>Start Session</button>
      <button id="downloadButton">Play Offline</button>
    </div>
  </div>

  <!-- Game Container -->
  <iframe id="gameFrame" src=""></iframe>

  <script>
    const bindings = { up: null, down: null, left: null, right: null };
    const display = {
      up: document.getElementById('keyUp'),
      down: document.getElementById('keyDown'),
      left: document.getElementById('keyLeft'),
      right: document.getElementById('keyRight'),
    };
    const bindOrder = ['up', 'down', 'left', 'right'];
    let step = 0;

    const startBtn = document.getElementById('startButton');
    const popup = document.getElementById('remapPopup');
    const iframe = document.getElementById('gameFrame');
    const downloadBtn = document.getElementById('downloadButton');

    function waitForKey() {
      const dir = bindOrder[step];
      display[dir].textContent = '[Press key]';
    }

    document.addEventListener('keydown', function handleBind(e) {
      if (popup.style.display === 'none') return;
      if (step >= bindOrder.length) return;
      const dir = bindOrder[step];
      bindings[dir] = e.key.toLowerCase();
      display[dir].textContent = e.key.toUpperCase();
      step++;
      if (step < bindOrder.length) {
        waitForKey();
      } else {
        startBtn.disabled = false;
        document.removeEventListener('keydown', handleBind);
      }
      e.preventDefault();
    });

    waitForKey();

    startBtn.onclick = () => {
      popup.style.display = 'none';
      iframe.src = "https://bobydob.github.io/JSEngine/build/m3m/";
      iframe.style.display = 'block';

      const keyMap = {
        [bindings.up]: 'ArrowUp',
        [bindings.down]: 'ArrowDown',
        [bindings.left]: 'ArrowLeft',
        [bindings.right]: 'ArrowRight',
      };

      document.addEventListener('keydown', (e) => {
        const translated = keyMap[e.key.toLowerCase()];
        if (translated) {
          iframe.contentWindow.dispatchEvent(new KeyboardEvent('keydown', { key: translated }));
          e.preventDefault();
        }
      });

      document.addEventListener('keyup', (e) => {
        const translated = keyMap[e.key.toLowerCase()];
        if (translated) {
          iframe.contentWindow.dispatchEvent(new KeyboardEvent('keyup', { key: translated }));
          e.preventDefault();
        }
      });
    };

    downloadBtn.onclick = () => {
      const content = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/Rabbibo/moto@35b09901c725d990145f7b305cbcb42ddcee4782/assets/css/app.css" />
</head>
<body>
  <div id="content"></div>
  <div id="orientation"></div>
  <div id="loader">Loading ...</div>
  <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Stypical/lacklack@0959ed15fc96078cbb053e4e3c259a62b3e9e296/motox3m/assets/lib/nape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Stypical/lacklack@0959ed15fc96078cbb053e4e3c259a62b3e9e296/motox3m/assets/lib/jquery-3.1.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Stypical/lacklack@0959ed15fc96078cbb053e4e3c259a62b3e9e296/motox3m/assets/lib/easeljs-0.8.2.combined.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/Stypical/lacklack@0959ed15fc96078cbb053e4e3c259a62b3e9e296/motox3m/assets/lib/bluebird.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/bobydob/JSEngine@0e96212fb7b2e7aa0a310d3ebe3a8ab01a114b4b/build/m3m/m3m.min.js"></script>
</body>
</html>`;
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "moto3xm-offline.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };
  </script>
</body>
</html>
